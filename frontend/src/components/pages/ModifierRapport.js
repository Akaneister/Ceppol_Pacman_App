/**
==================================================================================
==================================================================================
@file ModifierRapport.js
@location frontend/src/components/pages/ModifierRapport.js
@description Composant de modification d'un rapport d'Ã©vÃ©nement maritime existant
FONCTIONNALITÃ‰S PRINCIPALES :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Modification complÃ¨te d'un rapport d'Ã©vÃ©nement maritime existant
â€¢ VÃ©rification des droits d'accÃ¨s (crÃ©ateur ou utilisateur autorisÃ©)
â€¢ PrÃ©remplissage automatique du formulaire avec les donnÃ©es existantes
â€¢ Carte interactive Leaflet pour sÃ©lection/modification des coordonnÃ©es GPS
â€¢ Gestion des types/sous-types d'Ã©vÃ©nements avec filtres dynamiques
â€¢ Sauvegarde des modifications avec tracking des changements
â€¢ Archivage du rapport avec confirmation utilisateur
â€¢ Historisation automatique des actions utilisateur

STRUCTURE DU COMPOSANT :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ VÃ©rification d'accÃ¨s : ContrÃ´le des permissions avant affichage
â€¢ Chargement des donnÃ©es : RÃ©cupÃ©ration du rapport et des listes de rÃ©fÃ©rence
â€¢ Formulaire complet : 6 sections organisÃ©es (Infos gÃ©nÃ©rales, Classification, etc.)
â€¢ Carte interactive : SÃ©lection visuelle des coordonnÃ©es avec marqueurs
â€¢ Actions : Modification, archivage avec confirmation

GESTION D'Ã‰TAT :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ hasAccess/accessChecked : ContrÃ´le des permissions utilisateur
â€¢ loading/error : Ã‰tats de chargement et gestion d'erreurs
â€¢ formData/ancienRapport : DonnÃ©es actuelles et originales pour comparaison
â€¢ mapInitialized/marker : Ã‰tat de la carte Leaflet et marqueurs
â€¢ isSubmitting/submitStatus : Ã‰tats de soumission et messages de retour

DÃ‰PENDANCES :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ React (hooks: useState, useEffect, useRef)
â€¢ AuthContext (authentification et informations utilisateur)
â€¢ React Router (navigation et paramÃ¨tres d'URL)
â€¢ Axios (requÃªtes HTTP vers l'API)
â€¢ Leaflet (cartographie interactive)

API UTILISÃ‰E :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ GET /rapports/:id/acces - VÃ©rification des droits d'accÃ¨s
â€¢ GET /rapports/:id - RÃ©cupÃ©ration des donnÃ©es du rapport
â€¢ GET /rapports/type-evenement - Liste des types d'Ã©vÃ©nements
â€¢ GET /rapports/sous-type-pollution - Liste des sous-types
â€¢ GET /rapports/origine-evenement - Liste des origines
â€¢ GET /rapports/zone-geographique - Liste des zones gÃ©ographiques
â€¢ PUT /rapports/:id/after - Modification du rapport
â€¢ POST /rapports/historique - Ajout d'une entrÃ©e d'historique

@author Oscar Vieujean
==================================================================================
*/

import { useState, useEffect, useRef } from 'react';
import { useAuth } from '../context/AuthContext';
import { useParams, useNavigate } from 'react-router-dom';
import axios from 'axios';
import 'leaflet/dist/leaflet.css';
import '../css/AjouterRapport.css'; // Utilisation du mÃªme fichier CSS pour la cohÃ©rence visuelle

// Configuration de l'URL de l'API depuis les variables d'environnement
const API = process.env.REACT_APP_API_URL;

const ModifierRapport = () => {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RÃ‰CUPÃ‰RATION DES PARAMÃˆTRES ET HOOKS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const { id } = useParams(); // rÃ©cupÃ¨re l'ID du rapport depuis l'URL
  const navigate = useNavigate(); // Navigation programmatique
  const { authData } = useAuth(); // DonnÃ©es d'authentification utilisateur

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ã‰TATS DE CONTRÃ”LE D'ACCÃˆS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const [hasAccess, setHasAccess] = useState(false); // Droit de modification
  const [accessChecked, setAccessChecked] = useState(false); // VÃ©rification effectuÃ©e

  // VÃ©rification des droits d'accÃ¨s au rapport
  useEffect(() => {
    const checkAccess = async () => {
      try {
        // RÃ©cupÃ©ration de la liste des utilisateurs ayant accÃ¨s au rapport
        const accesResponse = await axios.get(`${API}/rapports/${id}/acces`);
        const accesList = accesResponse.data;

        // RÃ©cupÃ©ration des informations du rapport pour vÃ©rifier le crÃ©ateur
        const rapportResponse = await axios.get(`${API}/rapports/${id}`);
        const rapport = rapportResponse.data.rapport || rapportResponse.data;

        // VÃ©rification si l'utilisateur est le crÃ©ateur du rapport
        const estCreateur = rapport.id_operateur === authData.Opid;
        // VÃ©rification si l'utilisateur a un accÃ¨s explicite au rapport
        const aAccess = accesList.some(acc => acc.id_operateur === authData.Opid);

        // L'utilisateur a accÃ¨s s'il est crÃ©ateur OU s'il a un accÃ¨s explicite
        setHasAccess(estCreateur || aAccess);

        // Note : Code dupliquÃ© ci-dessous (Ã  nettoyer)
        if (estCreateur || aAccess) {
          setHasAccess(true);
        } else {
          setHasAccess(false);
        }
      } catch (error) {
        console.error('Erreur lors de la vÃ©rification de l\'accÃ¨s :', error);
        setHasAccess(false);
      } finally {
        setAccessChecked(true);
      }
    };
    checkAccess();
  }, [authData, id]);


  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ã‰TATS DE GESTION DU FORMULAIRE ET DE LA CARTE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const [isSubmitting, setIsSubmitting] = useState(false); // Ã‰tat de soumission
  const [submitStatus, setSubmitStatus] = useState(null); // Messages de retour
  const [loading, setLoading] = useState(true); // Chargement des donnÃ©es
  const [error, setError] = useState(''); // Messages d'erreur

  // RÃ©fÃ©rences pour la gestion de la carte Leaflet
  const mapRef = useRef(null); // RÃ©fÃ©rence du conteneur de la carte
  const leafletMapRef = useRef(null); // RÃ©fÃ©rence de l'instance Leaflet
  const [mapInitialized, setMapInitialized] = useState(false); // Ã‰tat d'initialisation
  const [marker, setMarker] = useState(null); // Marqueur sur la carte

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ã‰TATS POUR LES LISTES DÃ‰ROULANTES DE RÃ‰FÃ‰RENCE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const [typesEvenement, setTypesEvenement] = useState([]); // Types d'Ã©vÃ©nements
  const [sousTypesEvenement, setSousTypesEvenement] = useState([]); // Sous-types complets
  const [originesEvenement, setOriginesEvenement] = useState([]); // Origines d'Ã©vÃ©nements
  const [zonesGeographiques, setZonesGeographiques] = useState([]); // Zones gÃ©ographiques
  const [filteredSousTypes, setFilteredSousTypes] = useState([]); // Sous-types filtrÃ©s


  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STRUCTURE INITIALE DU FORMULAIRE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // DÃ©finition de la structure complÃ¨te d'un rapport avec valeurs par dÃ©faut
  const initialFormData = {
    // Informations gÃ©nÃ©rales
    titre: '',
    date_evenement: '',
    heure_evenement: '',
    description_globale: '',
    
    // Classification de l'Ã©vÃ©nement
    id_type_evenement: '',
    id_sous_type_evenement: '',
    id_origine_evenement: '',
    
    // Informations sur la cible
    id_cible: '',
    nom_cible: '',
    pavillon_cible: '',
    libelle: '',
    immatriculation: '',
    TypeProduit: '',
    QuantiteProduit: '',
    
    // Localisation
    id_zone: '',
    details_lieu: '',
    latitude: '',
    longitude: '',
    
    // Conditions mÃ©tÃ©orologiques
    direction_vent: '',
    force_vent: '',
    etat_mer: '',
    nebulosite: '',
    maree: '',
    
    // Alertes et contacts (checkboxes)
    cedre_alerte: false,
    cross_alerte: false,
    photo: false,
    message_polrep: false,
    derive_mothy: false,
    polmar_terre: false,
    smp: false,
    bsaa: false,
    sensible_proximite: false,
    
    // Moyens et risques
    moyen_proximite: '',
    moyen_depeche: '',
    moyen_marine_etat: '',
    risque_court_terme: '',
    risque_moyen_long_terme: '',
    delai_appareillage: ''
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ã‰TATS DES DONNÃ‰ES DU FORMULAIRE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const [formData, setFormData] = useState(initialFormData); // DonnÃ©es actuelles
  const [ancienRapport, setAncienRapport] = useState(initialFormData); // DonnÃ©es originales pour comparaison






  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CHARGEMENT DES DONNÃ‰ES DU RAPPORT ET DES LISTES DE RÃ‰FÃ‰RENCE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  useEffect(() => {
    const fetchData = async () => {
      console.log('ğŸ“¥ DÃ©but du chargement des donnÃ©es du rapport et des listes dÃ©roulantes...');
      try {
        setLoading(true);
        setError('');

        console.log('ğŸ”„ RequÃªtes en cours vers l\'API...');
        
        // Chargement parallÃ¨le de toutes les donnÃ©es nÃ©cessaires
        const [
          typesRes,        // Types d'Ã©vÃ©nements
          sousTypesRes,    // Sous-types de pollution
          originesRes,     // Origines d'Ã©vÃ©nements
          zonesRes,        // Zones gÃ©ographiques
          rapportRes,      // DonnÃ©es du rapport Ã  modifier
        ] = await Promise.all([
          axios.get(`${API}/rapports/type-evenement`),
          axios.get(`${API}/rapports/sous-type-pollution`),
          axios.get(`${API}/rapports/origine-evenement`),
          axios.get(`${API}/rapports/zone-geographique`),
          axios.get(`${API}/rapports/${id}`),
        ]);

        console.log('âœ… DonnÃ©es des listes dÃ©roulantes rÃ©cupÃ©rÃ©es avec succÃ¨s.');

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // MISE Ã€ JOUR DES LISTES DE RÃ‰FÃ‰RENCE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        setTypesEvenement(typesRes.data);
        setSousTypesEvenement(sousTypesRes.data);
        setOriginesEvenement(originesRes.data);
        setZonesGeographiques(zonesRes.data);

        console.log('ğŸ“¦ RÃ©cupÃ©ration et traitement des donnÃ©es du rapport...');
        
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // EXTRACTION DES DONNÃ‰ES DU RAPPORT
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const rapportData = rapportRes.data.rapport || rapportRes.data;
        const metaData = rapportRes.data.metaData || {};

        // ğŸ§¾ Affichage brut des donnÃ©es rÃ©cupÃ©rÃ©es pour dÃ©bogage
        console.log('ğŸ“„ DonnÃ©es du rapport rÃ©cupÃ©rÃ©es :', rapportData);
        console.log('ğŸ“„ MetaData associÃ©es :', metaData);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // FORMATAGE DE LA DATE ET HEURE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let dateEvenement = '';
        let heureEvenement = '';

        if (rapportData.date_evenement) {
          const dateObj = new Date(rapportData.date_evenement);
          dateEvenement = dateObj.toISOString().split('T')[0]; // Format YYYY-MM-DD
          heureEvenement = dateObj.toTimeString().substring(0, 5); // Format HH:MM
          console.log(`ğŸ•’ Date UTC reÃ§ue : ${rapportData.date_evenement} â†’ affichÃ©e : ${dateEvenement} ${heureEvenement}`);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CONSTRUCTION DE L'OBJET FORMULAIRE PRÃ‰REMPLI
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const newFormData = {
          // Informations gÃ©nÃ©rales du rapport
          titre: rapportData.titre || '',
          date_evenement: dateEvenement,
          heure_evenement: heureEvenement,
          description_globale: rapportData.description_globale || '',
          id_type_evenement: rapportData.id_type_evenement?.toString() || '',
          id_sous_type_evenement: rapportData.id_sous_type_evenement?.toString() || '',
          id_origine_evenement: rapportData.id_origine_evenement?.toString() || '',

          // Informations sur la cible (depuis metaData)
          id_cible: metaData.cible?.id_type_cible?.toString() || '',
          nom_cible: metaData.cible?.nom || '',
          pavillon_cible: metaData.cible?.pavillon || '',
          libelle: metaData.typeCible?.libelle || '',
          immatriculation: metaData.cible?.immatriculation || '',
          TypeProduit: metaData.cible?.TypeProduit || '',
          QuantiteProduit: metaData.cible?.QuantiteProduit || '',

          // Informations de localisation
          id_zone: metaData.localisation?.id_zone?.toString() || '',
          details_lieu: metaData.localisation?.details_lieu || '',
          latitude: metaData.localisation?.latitude?.toString() || '',
          longitude: metaData.localisation?.longitude?.toString() || '',

          // Conditions mÃ©tÃ©orologiques
          direction_vent: metaData.meteo?.direction_vent || '',
          force_vent: metaData.meteo?.force_vent?.toString() || '',
          etat_mer: metaData.meteo?.etat_mer?.toString() || '',
          nebulosite: metaData.meteo?.nebulosite?.toString() || '',
          maree: metaData.meteo?.maree || '',

          // Alertes et contacts (conversion 1/0 vers boolean)
          cedre_alerte: metaData.alertes?.cedre === 1,
          cross_alerte: metaData.alertes?.cross_contact === 1,
          photo: metaData.alertes?.photo === 1,
          message_polrep: metaData.alertes?.polrep === 1,
          derive_mothy: metaData.alertes?.derive_mothy === 1,
          polmar_terre: metaData.alertes?.pne === 1,
          smp: metaData.alertes?.smp === 1,
          bsaa: metaData.alertes?.bsaa === 1,
          sensible_proximite: metaData.alertes?.sensible_proximite === 1,

          // Moyens et autres informations
          moyen_proximite: metaData.alertes?.moyen_proximite || '',
          moyen_depeche: metaData.alertes?.moyen_depeche || '',
          moyen_marine_etat: metaData.alertes?.moyen_marine_etat || '',

          // Ã‰valuation des risques
          risque_court_terme: metaData.alertes?.risque_court_terme || '',
          risque_moyen_long_terme: metaData.alertes?.risque_moyen_long_terme || '',

          // DÃ©lai d'appareillage pour BSAA
          delai_appareillage: metaData.alertes?.delai_appareillage_bsaa || ''
        };

        console.log('ğŸ“ Formulaire prÃ©rempli avec :', newFormData);
        
        // Mise Ã  jour des Ã©tats avec les donnÃ©es rÃ©cupÃ©rÃ©es
        setFormData(newFormData);
        setAncienRapport(newFormData); // Sauvegarde pour comparaison future

      } catch (err) {
        console.error('âŒ Erreur lors du chargement des donnÃ©es :', err);
        setError('Impossible de charger les donnÃ©es du rapport.');
      } finally {
        setLoading(false);
        console.log('âœ… Chargement terminÃ©.');
      }
    };

    fetchData();
  }, [id]);




  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FILTRAGE DYNAMIQUE DES SOUS-TYPES D'Ã‰VÃ‰NEMENTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Filtre les sous-types en fonction du type d'Ã©vÃ©nement sÃ©lectionnÃ©
  useEffect(() => {
    if (formData.id_type_evenement) {
      const filtered = sousTypesEvenement.filter(
        sousType => sousType.id_type_evenement === parseInt(formData.id_type_evenement)
      );
      setFilteredSousTypes(filtered);
    } else {
      setFilteredSousTypes([]);
    }
  }, [formData.id_type_evenement, sousTypesEvenement]);


  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INITIALISATION ET GESTION DE LA CARTE LEAFLET
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  useEffect(() => {
    // VÃ©rifications prÃ©alables avant initialisation de la carte
    if (mapRef.current && !mapInitialized && typeof window !== 'undefined' && formData.latitude && formData.longitude) {
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // CHARGEMENT DYNAMIQUE DE LEAFLET SI NÃ‰CESSAIRE
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if (!window.L) {
        // CrÃ©ation du script Leaflet
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
        script.crossOrigin = '';

        // Ajout de la feuille de style Leaflet si absente
        if (!document.querySelector('link[href*="leaflet.css"]')) {
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
          link.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
          link.crossOrigin = '';
          document.head.appendChild(link);
        }

        script.onload = initMap; // Initialisation aprÃ¨s chargement
        document.head.appendChild(script);
      } else {
        initMap(); // Leaflet dÃ©jÃ  disponible
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // FONCTION D'INITIALISATION DE LA CARTE
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function initMap() {
      try {
        console.log("ğŸ—ºï¸ Initialisation de la carte...");

        // Nettoyage de l'instance prÃ©cÃ©dente si elle existe
        if (leafletMapRef.current) {
          leafletMapRef.current.remove();
        }

        // Position initiale basÃ©e sur les coordonnÃ©es du rapport
        const initialPosition = [
          parseFloat(formData.latitude),
          parseFloat(formData.longitude) 
        ];

        // CrÃ©ation de la nouvelle instance de carte
        leafletMapRef.current = window.L.map(mapRef.current).setView(initialPosition, 10);

        // Ajout de la couche de tuiles OpenStreetMap
        window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(leafletMapRef.current);

        // Ajout du marqueur Ã  la position initiale si coordonnÃ©es disponibles
        if (formData.latitude && formData.longitude) {
          const newMarker = window.L.marker(initialPosition).addTo(leafletMapRef.current);
          setMarker(newMarker);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // GESTIONNAIRE DE CLIC SUR LA CARTE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        leafletMapRef.current.on('click', function (e) {
          const { lat, lng } = e.latlng;

          // Mise Ã  jour des champs de coordonnÃ©es dans le formulaire
          setFormData(prev => ({
            ...prev,
            latitude: lat.toFixed(6),
            longitude: lng.toFixed(6)
          }));

          // Mise Ã  jour ou crÃ©ation du marqueur
          if (marker) {
            marker.setLatLng([lat, lng]);
          } else {
            const newMarker = window.L.marker([lat, lng]).addTo(leafletMapRef.current);
            setMarker(newMarker);
          }

          console.log(`Position sÃ©lectionnÃ©e: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
        });

        // Force la recalculation de la taille de la carte aprÃ¨s initialisation
        setTimeout(() => {
          if (leafletMapRef.current) {
            leafletMapRef.current.invalidateSize();
          }
        }, 200);

        setMapInitialized(true);
        console.log("âœ… Carte initialisÃ©e avec succÃ¨s");
      } catch (error) {
        console.error('Erreur lors de l\'initialisation de la carte:', error);
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // NETTOYAGE AU DÃ‰MONTAGE DU COMPOSANT
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    return () => {
      if (leafletMapRef.current) {
        leafletMapRef.current.remove();
        leafletMapRef.current = null;
      }
    };
  }, [formData.latitude, formData.longitude, mapInitialized, marker]);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GESTIONNAIRES D'Ã‰VÃ‰NEMENTS DU FORMULAIRE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Gestionnaire gÃ©nÃ©rique des changements dans le formulaire
  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    const newValue = type === 'checkbox' ? checked : value;
    setFormData(prev => ({ ...prev, [name]: newValue }));
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SYNCHRONISATION CARTE â†” COORDONNÃ‰ES MANUELLES
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  // Met Ã  jour la carte si les coordonnÃ©es sont modifiÃ©es manuellement
  useEffect(() => {
    if (mapInitialized && leafletMapRef.current && formData.latitude && formData.longitude) {
      const lat = parseFloat(formData.latitude);
      const lng = parseFloat(formData.longitude);

      if (!isNaN(lat) && !isNaN(lng)) {
        // Centrage de la carte sur les nouvelles coordonnÃ©es
        leafletMapRef.current.setView([lat, lng], 12);

        // Mise Ã  jour ou crÃ©ation du marqueur
        if (marker) {
          marker.setLatLng([lat, lng]);
        } else {
          const newMarker = window.L.marker([lat, lng]).addTo(leafletMapRef.current);
          setMarker(newMarker);
        }
      }
    }
  }, [formData.latitude, formData.longitude, mapInitialized, marker]);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VALIDATION DU FORMULAIRE AVANT SOUMISSION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const validateForm = () => {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // VÃ‰RIFICATION DES CHAMPS OBLIGATOIRES
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (!formData.titre || !formData.date_evenement || !formData.heure_evenement ||
      !formData.id_type_evenement || !formData.description_globale || !formData.id_zone) {
      setSubmitStatus({
        type: 'error',
        message: 'Veuillez remplir tous les champs obligatoires (marquÃ©s par *).'
      });
      return false;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // VÃ‰RIFICATION DES MODIFICATIONS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const isModified = Object.keys(formData).some(
      key => formData[key] !== ancienRapport[key]
    );
    if (!isModified) {
      setSubmitStatus({
        type: 'error',
        message: 'Aucune modification dÃ©tectÃ©e. Modifiez au moins un champ pour enregistrer.'
      });
      return false;
    }

    return true;
  };


  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FONCTION D'ARCHIVAGE DU RAPPORT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const handleArchiver = async (e) => {
    // Demande de confirmation avant archivage
    const confirmation = window.confirm("Voulez-vous vraiment archiver ce rapport ? Cette action est irrÃ©versible.");
    if (!confirmation) return;
    
    e.preventDefault();
    setIsSubmitting(true);
    setSubmitStatus(null);

    try {
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // PRÃ‰PARATION DES DONNÃ‰ES POUR L'ARCHIVAGE
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const dateTimeString = `${formData.date_evenement}T${formData.heure_evenement}:00`;

      // Structure du rapport avec flag d'archivage
      const rapport = {
        titre: formData.titre,
        date_evenement: dateTimeString,
        description_globale: formData.description_globale,
        id_operateur: authData.Opid,
        id_type_evenement: formData.id_type_evenement ? parseInt(formData.id_type_evenement) : null,
        id_sous_type_evenement: formData.id_sous_type_evenement ? parseInt(formData.id_sous_type_evenement) : null,
        id_origine_evenement: formData.id_origine_evenement ? parseInt(formData.id_origine_evenement) : null,
        archive: 1 // âœ… Flag d'archivage
      };

      // MÃ©tadonnÃ©es associÃ©es au rapport
      const metaData = {
        cible: {
          id_cible: formData.id_cible || null,
          nom_cible: formData.nom_cible || null,
          pavillon_cible: formData.pavillon_cible || null,
          libelle: formData.libelle || null,
        },
        localisation: {
          id_zone: formData.id_zone ? parseInt(formData.id_zone) : null,
          details_lieu: formData.details_lieu || null,
          latitude: formData.latitude ? parseFloat(formData.latitude) : null,
          longitude: formData.longitude ? parseFloat(formData.longitude) : null,
        },
        meteo: {
          direction_vent: formData.direction_vent || null,
          force_vent: formData.force_vent ? parseInt(formData.force_vent) : null,
          etat_mer: formData.etat_mer ? parseInt(formData.etat_mer) : null,
          nebulosite: formData.nebulosite ? parseInt(formData.nebulosite) : null,
        },
        alertes: {
          cedre_alerte: formData.cedre_alerte ? 1 : 0,
          cross_alerte: formData.cross_alerte ? 1 : 0,
          photo: formData.photo ? 1 : 0,
          polrep: formData.polrep ? 1 : 0,
          derive_mothy: formData.derive_mothy ? 1 : 0,
          polmar_terre: formData.polmar_terre ? 1 : 0,
          smp: formData.smp ? 1 : 0,
          bsaa: formData.bsaa ? 1 : 0,
          delai_appareillage: formData.delai_appareillage || null,
        }
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ENVOI DE LA REQUÃŠTE D'ARCHIVAGE
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const response = await axios.put(`${API}/rapports/${id}/after`, {
        rapport,
        metaData
      });

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // GÃ‰NÃ‰RATION DU DÃ‰TAIL D'ACTION POUR L'HISTORIQUE
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function genererDetailAction(ancien, nouveau) {
        console.log('Ancien rapport:', ancien);
        const modifications = [];

        // Parcours des champs pour dÃ©tecter les changements
        for (const champ in nouveau) {
          const ancienVal = ancien[champ];
          const nouveauVal = nouveau[champ];

          if (ancienVal !== nouveauVal) {
            modifications.push(`${champ} : "${ancienVal}" â†’ "${nouveauVal}"`);
          }
        }

        return modifications.length > 0
          ? `Champs modifiÃ©s :\n- ${modifications.join('\n- ')}`
          : 'Aucune modification dÃ©tectÃ©e';
      }

      const detail_action = genererDetailAction(ancienRapport, formData);

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // AJOUT D'UNE ENTRÃ‰E D'HISTORIQUE
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      console.log('detail_action:', detail_action);
      await axios.post(`${API}/rapports/historique`, {
        id_rapport: id,
        id_operateur: authData.Opid,
        type_action: 'Modification Rapport',
        date_action: new Date(new Date().getTime() + 2 * 60 * 60 * 1000).toISOString(),
        detail_action
      });

      console.log('Rapport archivÃ© avec succÃ¨s:', response.data);
      setSubmitStatus({ type: 'success', message: 'Rapport mis Ã  jour avec succÃ¨s!' });

      // Redirection aprÃ¨s succÃ¨s
      setTimeout(() => {
        navigate('/liste-rapports');
      }, 2000);
      
    } catch (error) {
      console.error('Erreur lors de la mise Ã  jour du rapport:', error);
      setSubmitStatus({
        type: 'error',
        message: error.response?.data?.message || 'Une erreur est survenue lors de la mise Ã  jour du rapport.'
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FONCTION PRINCIPALE DE MODIFICATION DU RAPPORT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  const handleSubmit = async (e) => {
    e.preventDefault();

    // Validation prÃ©alable du formulaire
    if (!validateForm()) return;

    setIsSubmitting(true);
    setSubmitStatus(null);

    try {
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // PRÃ‰PARATION DES DONNÃ‰ES DE MODIFICATION
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const dateTimeString = `${formData.date_evenement}T${formData.heure_evenement}:00`;

      // Structure principale du rapport (sans archivage)
      const rapport = {
        titre: formData.titre,
        date_evenement: dateTimeString,
        description_globale: formData.description_globale,
        id_operateur: authData.Opid,
        id_type_evenement: formData.id_type_evenement ? parseInt(formData.id_type_evenement) : null,
        id_sous_type_evenement: formData.id_sous_type_evenement ? parseInt(formData.id_sous_type_evenement) : null,
        id_origine_evenement: formData.id_origine_evenement ? parseInt(formData.id_origine_evenement) : null,
      };

      // MÃ©tadonnÃ©es complÃ¨tes du rapport
      const metaData = {
        cible: {
          id_cible: formData.id_cible || null,
          nom_cible: formData.nom_cible || null,
          pavillon_cible: formData.pavillon_cible || null,
          libelle: formData.libelle || null,
        },
        localisation: {
          id_zone: formData.id_zone ? parseInt(formData.id_zone) : null,
          details_lieu: formData.details_lieu || null,
          latitude: formData.latitude ? parseFloat(formData.latitude) : null,
          longitude: formData.longitude ? parseFloat(formData.longitude) : null,
        },
        meteo: {
          direction_vent: formData.direction_vent || null,
          force_vent: formData.force_vent ? parseInt(formData.force_vent) : null,
          etat_mer: formData.etat_mer ? parseInt(formData.etat_mer) : null,
          nebulosite: formData.nebulosite ? parseInt(formData.nebulosite) : null,
        },
        alertes: {
          cedre_alerte: formData.cedre_alerte ? 1 : 0,
          cross_alerte: formData.cross_alerte ? 1 : 0,
          photo: formData.photo ? 1 : 0,
          polrep: formData.polrep ? 1 : 0,
          derive_mothy: formData.derive_mothy ? 1 : 0,
          polmar_terre: formData.polmar_terre ? 1 : 0,
          smp: formData.smp ? 1 : 0,
          bsaa: formData.bsaa ? 1 : 0,
          delai_appareillage: formData.delai_appareillage || null,
        }
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ENVOI DE LA REQUÃŠTE DE MODIFICATION
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const response = await axios.put(`${API}/rapports/${id}/after`, {
        rapport,
        metaData
      });

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // GÃ‰NÃ‰RATION DU DÃ‰TAIL D'ACTION POUR L'HISTORIQUE
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function genererDetailAction(ancien, nouveau) {
        console.log('Ancien rapport:', ancien);
        const modifications = [];

        // DÃ©tection des changements entre ancien et nouveau
        for (const champ in nouveau) {
          const ancienVal = ancien[champ];
          const nouveauVal = nouveau[champ];

          if (ancienVal !== nouveauVal) {
            modifications.push(`${champ} : "${ancienVal}" â†’ "${nouveauVal}"`);
          }
        }

        return modifications.length > 0
          ? `Champs modifiÃ©s :\n- ${modifications.join('\n- ')}`
          : 'Aucune modification dÃ©tectÃ©e';
      }

      const detail_action = genererDetailAction(ancienRapport, formData);

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // AJOUT D'UNE ENTRÃ‰E D'HISTORIQUE
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      console.log('detail_action:', detail_action);
      await axios.post(`${API}/rapports/historique`, {
        id_rapport: id,
        id_operateur: authData.Opid,
        type_action: 'Modification Rapport',
        date_action: new Date(new Date().getTime() + 2 * 60 * 60 * 1000).toISOString(),
        detail_action
      });

      console.log('Rapport mis Ã  jour avec succÃ¨s:', response.data);
      setSubmitStatus({ type: 'success', message: 'Rapport mis Ã  jour avec succÃ¨s!' });

      // Redirection aprÃ¨s succÃ¨s
      setTimeout(() => {
        navigate('/liste-rapports');
      }, 2000);
      
    } catch (error) {
      console.error('Erreur lors de la mise Ã  jour du rapport:', error);
      setSubmitStatus({
        type: 'error',
        message: error.response?.data?.message || 'Une erreur est survenue lors de la mise Ã  jour du rapport.'
      });
    } finally {
      setIsSubmitting(false);
    }
  };



  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AFFICHAGE CONDITIONNEL SELON L'Ã‰TAT DE CHARGEMENT ET D'ACCÃˆS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Ã‰tat de chargement initial
  if (loading) return (
    <div className="loading-container">
      <div className="loading-spinner"></div>
      <p>Chargement des donnÃ©es du rapport...</p>
    </div>
  );

  // Ã‰tat d'erreur de chargement
  if (error) return (
    <div className="error-container">
      <h2>Erreur</h2>
      <p>{error}</p>
      <button className="btn-primary" onClick={() => navigate('/liste-rapports')}>
        Retour Ã  la liste des rapports
      </button>
    </div>
  );

  // VÃ©rification des permissions en cours
  if (!accessChecked) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <p>VÃ©rification des permissions...</p>
      </div>
    );
  }

  // AccÃ¨s refusÃ©
  if (!hasAccess) {
    return (
      <div className="error-container">
        <h2>AccÃ¨s refusÃ©</h2>
        <p>Vous n'avez pas les droits pour modifier ce rapport.</p>
        <br></br>
        <button className="btn-primary" onClick={() => navigate('/liste-rapports')}>
          Retour Ã  la liste des rapports
        </button>
      </div>
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LOGIQUE D'AFFICHAGE CONDITIONNEL DES CHAMPS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Affichage du champ dÃ©lai d'appareillage seulement si BSAA est cochÃ©
  const showDelaiAppareillage = formData.bsaa;

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDU PRINCIPAL DU COMPOSANT - FORMULAIRE DE MODIFICATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  return (
    <div className="rapport-container">
      {/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {/* EN-TÃŠTE DU FORMULAIRE                                                  */}
      {/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <div className="rapport-header">
        <h1>Modifier Un rapport d'Evenement</h1>
        <p className="rapport-subtitle" style={{ fontSize: '0.9em', fontStyle: 'italic' }}>
          ComplÃ©tez tous les champs obligatoires (*) pour soumettre un nouveau rapport
        </p>
      </div>

      {/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {/* FORMULAIRE PRINCIPAL DE MODIFICATION                                   */}
      {/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      <form className="rapport-form" onSubmit={handleSubmit}>
        
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {/* SECTION 1 : INFORMATIONS GÃ‰NÃ‰RALES                                  */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        <div className="form-section">
          <h2>Informations GÃ©nÃ©rales</h2>

          {/* Titre du rapport */}
          <div className="form-group">
            <label htmlFor="titre">
              Titre du rapport *
              <span className="tooltip-icon" title="Donnez un titre court et descriptif">â„¹ï¸</span>
            </label>
            <input
              id="titre"
              type="text"
              name="titre"
              value={formData.titre}
              onChange={handleChange}
              className="form-control"
              placeholder="Ex: Incident de dÃ©versement dans le secteur nord"
              required
              maxLength="200"
            />
          </div>

          {/* Date et heure de l'Ã©vÃ©nement */}
          <div className="form-row">
            <div className="form-group">
              <label htmlFor="date_evenement">
                Date de l'Ã©vÃ©nement *
                <span className="tooltip-icon" title="Date Ã  laquelle l'Ã©vÃ©nement s'est produit">â„¹ï¸</span>
              </label>
              <input
                id="date_evenement"
                type="date"
                name="date_evenement"
                value={formData.date_evenement}
                onChange={handleChange}
                className="form-control"
                required
              />
            </div>

            <div className="form-group">
              <label htmlFor="heure_evenement">
                Heure de l'Ã©vÃ©nement *
                <span className="tooltip-icon" title="Heure Ã  laquelle l'Ã©vÃ©nement s'est produit">â„¹ï¸</span>
              </label>
              <input
                id="heure_evenement"
                type="time"
                name="heure_evenement"
                value={formData.heure_evenement}
                onChange={handleChange}
                className="form-control"
                required
              />
            </div>
          </div>
        </div>

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {/* SECTION 2 : CLASSIFICATION DE L'Ã‰VÃ‰NEMENT                           */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        <div className="form-section">
          <h2>Classification de l'Ã‰vÃ©nement</h2>

          <div className="form-row">
            {/* Type d'Ã©vÃ©nement avec filtrage des sous-types */}
            <div className="form-group">
              <label htmlFor="id_type_evenement">
                Type d'Ã©vÃ©nement *
                <span className="tooltip-icon" title="CatÃ©gorie principale de l'Ã©vÃ©nement">â„¹ï¸</span>
              </label>
              <select
                id="id_type_evenement"
                name="id_type_evenement"
                value={formData.id_type_evenement}
                onChange={handleChange}
                className="form-control"
                required
              >
                <option value="">-- SÃ©lectionner --</option>
                {typesEvenement.map(type => (
                  <option key={type.id_type_evenement} value={type.id_type_evenement}>
                    {type.libelle}
                  </option>
                ))}
              </select>
            </div>

            {/* Sous-type d'Ã©vÃ©nement (filtrÃ© par le type sÃ©lectionnÃ©) */}
            <div className="form-group">
              <label htmlFor="id_sous_type_evenement">
                PrÃ©cision du type d'Ã©vÃ©nement
                <span className="tooltip-icon" title="SpÃ©cification du type d'Ã©vÃ©nement">â„¹ï¸</span>
              </label>
              <select
                id="id_sous_type_evenement"
                name="id_sous_type_evenement"
                value={formData.id_sous_type_evenement}
                onChange={handleChange}
                className="form-control"
                disabled={!formData.id_type_evenement}
              >
                <option value="">-- SÃ©lectionner --</option>
                {filteredSousTypes.map(sousType => (
                  <option key={sousType.id_sous_type_evenement} value={sousType.id_sous_type_evenement}>
                    {sousType.libelle}
                  </option>
                ))}
              </select>
            </div>
          </div>

          {/* Origine de l'Ã©vÃ©nement */}
          <div className="form-group">
            <label htmlFor="id_origine_evenement">
              Origine de l'Ã©vÃ©nement
              <span className="tooltip-icon" title="Source ou cause de l'Ã©vÃ©nement">â„¹ï¸</span>
            </label>
            <select
              id="id_origine_evenement"
              name="id_origine_evenement"
              value={formData.id_origine_evenement}
              onChange={handleChange}
              className="form-control"
            >
              <option value="">-- SÃ©lectionner --</option>
              {originesEvenement.map(origine => (
                <option key={origine.id_origine_evenement} value={origine.id_origine_evenement}>
                  {origine.libelle}
                </option>
              ))}
            </select>
          </div>
        </div>

        {/* ...existing code... */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {/* SECTION 3 : CIBLE DE L'Ã‰VÃ‰NEMENT                                    */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        <div className="form-section">
          <h2>Cible de l'Ã‰vÃ©nement</h2>

          {/* Type de cible */}
          <div className="form-group">
            <label htmlFor="libelle">
              Type de cible
              <span className="tooltip-icon" title="Type d'objet ou entitÃ© ciblÃ© par l'Ã©vÃ©nement">â„¹ï¸</span>
            </label>
            <input
              type="text"
              id="libelle"
              name="libelle"
              value={formData.libelle}
              onChange={handleChange}
              className="form-control"
              placeholder="Ex: Navire, Installation, etc."
            />
          </div>

          {/* Informations dÃ©taillÃ©es de la cible */}
          <div className="form-row">
            <div className="form-group">
              <label htmlFor="nom_cible">
                Nom de la cible
                <span className="tooltip-icon" title="Nom du navire, de l'installation, etc.">â„¹ï¸</span>
              </label>
              <input
                id="nom_cible"
                type="text"
                name="nom_cible"
                value={formData.nom_cible}
                onChange={handleChange}
                className="form-control"
                placeholder="Ex: Navire Cargo XYZ"
              />
            </div>

            <div className="form-group">
              <label htmlFor="pavillon_cible">
                Pavillon
                <span className="tooltip-icon" title="Pays d'enregistrement (pour navires)">â„¹ï¸</span>
              </label>
              <input
                id="pavillon_cible"
                type="text"
                name="pavillon_cible"
                value={formData.pavillon_cible}
                onChange={handleChange}
                className="form-control"
                placeholder="Ex: France"
              />
            </div>

            <div className="form-group">
              <label htmlFor="immatriculation">
                Immatriculation
                <span className="tooltip-icon" title="MMSI/IMO Info immatriculation">â„¹ï¸</span>
              </label>
              <input
                id="immatriculation"
                type="text"
                name="immatriculation"
                value={formData.immatriculation}
                onChange={handleChange}
                className="form-control"
                placeholder="Ex: MMSI/IMO Info immatriculation"
              />
            </div>
          </div>

          {/* Informations sur le produit impliquÃ© */}
          <div className="form-row">
            <div className="form-group">
              <label htmlFor="TypeProduit">
                Type Produit
                <span className="tooltip-icon" title="Type Produit">â„¹ï¸</span>
              </label>
              <input
                id="TypeProduit"
                type="text"
                name="TypeProduit"
                value={formData.TypeProduit}
                onChange={handleChange}
                className="form-control"
                placeholder="Ex: fioul lourd, Huile, etc."
              />
            </div>

            <div className="form-group">
              <label htmlFor="QuantiteProduit">
                Quantite Produit
                <span className="tooltip-icon" title="Quantite de Produit">â„¹ï¸</span>
              </label>
              <input
                id="QuantiteProduit"
                type="text"
                name="QuantiteProduit"
                value={formData.QuantiteProduit}
                onChange={handleChange}
                className="form-control"
                placeholder="Ex: 1000L, 1000T, etc."
              />
            </div>
          </div>
        </div>

        {/* ...existing code... */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {/* SECTION 4 : LOCALISATION DE L'Ã‰VÃ‰NEMENT                             */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        <div className="form-section">
          <h2>Localisation de l'Ã‰vÃ©nement</h2>

          {/* Zone gÃ©ographique */}
          <div className="form-group">
            <label htmlFor="id_zone">
              Zone gÃ©ographique *
              <span className="tooltip-icon" title="Mer ou zone maritime oÃ¹ s'est produit l'Ã©vÃ©nement">â„¹ï¸</span>
            </label>
            <select
              id="id_zone"
              name="id_zone"
              value={formData.id_zone}
              onChange={handleChange}
              className="form-control"
              required
            >
              <option value="">-- SÃ©lectionner une zone --</option>
              {zonesGeographiques.map(zone => (
                <option key={zone.id_zone} value={zone.id_zone}>
                  {zone.nom_zone}
                </option>
              ))}
            </select>
          </div>

          {/* Description prÃ©cise du lieu */}
          <div className="form-group">
            <label htmlFor="details_lieu">
              PrÃ©cision sur le lieu
              <span className="tooltip-icon" title="Description prÃ©cise de l'emplacement">â„¹ï¸</span>
            </label>
            <textarea
              id="details_lieu"
              name="details_lieu"
              value={formData.details_lieu}
              onChange={handleChange}
              className="form-control"
              placeholder="DÃ©crivez l'emplacement prÃ©cis (ex: 2 milles nautiques au sud du port de..."
              rows="3"
            />
          </div>

          {/* CoordonnÃ©es GPS */}
          <div className="form-row">
            <div className="form-group">
              <label htmlFor="latitude">
                Latitude
                <span className="tooltip-icon" title="Format dÃ©cimal (ex: 43.296398)">â„¹ï¸</span>
              </label>
              <input
                id="latitude"
                type="text"
                name="latitude"
                value={formData.latitude}
                onChange={handleChange}
                className="form-control"
                placeholder="Ex: 43.296398"
              />
            </div>

            <div className="form-group">
              <label htmlFor="longitude">
                Longitude
                <span className="tooltip-icon" title="Format dÃ©cimal (ex: 5.369779)">â„¹ï¸</span>
              </label>
              <input
                id="longitude"
                type="text"
                name="longitude"
                value={formData.longitude}
                onChange={handleChange}
                className="form-control"
                placeholder="Ex: 5.369779"
              />
            </div>
          </div>

          {/* Carte interactive pour sÃ©lection des coordonnÃ©es */}
          <div className="map-container">
            <label>SÃ©lectionnez un point sur la carte (cliquez pour dÃ©finir les coordonnÃ©es)</label>
            <div
              ref={mapRef}
              id="map"
              className="location-map"
              style={{ height: '300px', width: '100%', marginTop: '10px' }}
            >
              {!mapInitialized && <div className="map-loading">Chargement de la carte...</div>}
            </div>
          </div>
        </div>

        {/* ...existing code... */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {/* SECTION 5 : CONDITIONS MÃ‰TÃ‰OROLOGIQUES                              */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        <div className="form-section">
          <h2>Conditions MÃ©tÃ©orologiques</h2>

          <div className="form-row">
            {/* Direction du vent et Ã©tat de la marÃ©e */}
            <div className="form-group">
              <label htmlFor="direction_vent">
                Direction du vent
                <span className="tooltip-icon" title="Direction d'oÃ¹ vient le vent">â„¹ï¸</span>
              </label>
              <select
                id="direction_vent"
                name="direction_vent"
                value={formData.direction_vent}
                onChange={handleChange}
                className="form-control"
              >
                <option value="">-- SÃ©lectionner --</option>
                <option value="N">Nord (N)</option>
                <option value="NE">Nord-Est (NE)</option>
                <option value="E">Est (E)</option>
                <option value="SE">Sud-Est (SE)</option>
                <option value="S">Sud (S)</option>
                <option value="SO">Sud-Ouest (SO)</option>
                <option value="O">Ouest (O)</option>
                <option value="NO">Nord-Ouest (NO)</option>
              </select>
            </div>

            <div className="form-group">
              <label htmlFor="maree">
                MarÃ©e
                <span className="tooltip-icon" title="Ã‰tat actuel de la marÃ©e (observation au moment du rapport)">â„¹ï¸</span>
              </label>
              <select
                id="maree"
                name="maree"
                value={formData.maree}
                onChange={handleChange}
                className="form-control"
              >
                <option value="">-- SÃ©lectionner --</option>
                <option value="haute">Haute mer</option>
                <option value="basse">Basse mer</option>
                <option value="montante">MarÃ©e montante</option>
                <option value="descendante">MarÃ©e descendante</option>
              </select>
            </div>

            {/* Force du vent avec slider */}
            <div className="form-group">
              <label htmlFor="force_vent">
                Force du vent (0-12)
                <span className="tooltip-icon" title="Ã‰chelle de Beaufort de 0 Ã  12">â„¹ï¸</span>
              </label>
              <input
                type="range"
                id="force_vent"
                name="force_vent"
                min="0"
                max="12"
                value={formData.force_vent}
                onChange={handleChange}
                className="form-control-range"
              />
              <div className="range-value">{formData.force_vent || '0'}</div>
            </div>
          </div>

          <div className="form-row">
            {/* Ã‰tat de la mer avec slider */}
            <div className="form-group">
              <label htmlFor="etat_mer">
                Ã‰tat de la mer (0-9)
                <span className="tooltip-icon" title="Ã‰chelle de Douglas de 0 Ã  9">â„¹ï¸</span>
              </label>
              <input
                type="range"
                id="etat_mer"
                name="etat_mer"
                min="0"
                max="9"
                value={formData.etat_mer}
                onChange={handleChange}
                className="form-control-range"
              />
              <div className="range-value">{formData.etat_mer || '0'}</div>
            </div>

            {/* NÃ©bulositÃ© avec slider */}
            <div className="form-group">
              <label htmlFor="nebulosite">
                NÃ©bulositÃ© (0-9)
                <span className="tooltip-icon" title="Ã‰chelle de couverture nuageuse de 0 Ã  9">â„¹ï¸</span>
              </label>
              <input
                type="range"
                id="nebulosite"
                name="nebulosite"
                min="0"
                max="9"
                value={formData.nebulosite}
                onChange={handleChange}
                className="form-control-range"
              />
              <div className="range-value">{formData.nebulosite || '0'}</div>
            </div>
          </div>
        </div>

        {/* ...existing code... */}
        <div className="form-section">
          <h2>Contacts et Alertes</h2>

          <div className="checkbox-grid">
            <div className="checkbox-item">
              <input
                id="cedre_alerte"
                type="checkbox"
                name="cedre_alerte"
                checked={formData.cedre_alerte}
                onChange={handleChange}
              />
              <label htmlFor="cedre_alerte">CEDRE alertÃ©</label>
            </div>

            <div className="checkbox-item">
              <input
                id="cross_alerte"
                type="checkbox"
                name="cross_alerte"
                checked={formData.cross_alerte}
                onChange={handleChange}
              />
              <label htmlFor="cross_alerte">CROSS alertÃ©</label>
            </div>



            <div className="checkbox-item">
              <input
                id="photo"
                type="checkbox"
                name="photo"
                checked={formData.photo}
                onChange={handleChange}
              />
              <label htmlFor="photo">Photo</label>
            </div>

            <div className="checkbox-item">
              <input
                id="message_polrep"
                type="checkbox"
                name="message_polrep"
                checked={formData.message_polrep}
                onChange={handleChange}
              />
              <label htmlFor="message_polrep">POLREP</label>
            </div>

            <div className="checkbox-item">
              <input
                id="derive_mothy"
                type="checkbox"
                name="derive_mothy"
                checked={formData.derive_mothy}
                onChange={handleChange}
              />
              <label htmlFor="derive_mothy">DÃ©rive MOTHY</label>
            </div>

            <div className="checkbox-item">
              <input
                id="polmar_terre"
                type="checkbox"
                name="polmar_terre"
                checked={formData.polmar_terre}
                onChange={handleChange}
              />
              <label htmlFor="polmar_terre">POLMAR Terre</label>
            </div>

            <div className="checkbox-item">
              <input
                id="smp"
                type="checkbox"
                name="smp"
                checked={formData.smp}
                onChange={handleChange}
              />
              <label htmlFor="smp">SMP</label>
            </div>

            <div className="checkbox-item">
              <input
                id="sensible_proximite"
                type="checkbox"
                name="sensible_proximite"
                checked={formData.sensible_proximite}
                onChange={handleChange}
              />
              <label htmlFor="sensible_proximite">Site sensible Ã  proximitÃ©</label>
            </div>

            <div className="checkbox-item">
              <input
                id="bsaa"
                type="checkbox"
                name="bsaa"
                checked={formData.bsaa}
                onChange={handleChange}
              />
              <label htmlFor="bsaa">BSAA</label>
            </div>
          </div>

          {/* Afficher le dÃ©lai d'appareillage seulement si BSAA est cochÃ© */}
          {showDelaiAppareillage && (
            <div className="form-group">
              <label htmlFor="delai_appareillage">
                DÃ©lai d'appareillage
                <span className="tooltip-icon" title="Date et heure d'appareillage pour BSAA">â„¹ï¸</span>
              </label>
              <input
                id="delai_appareillage"
                type="datetime-local"
                name="delai_appareillage"
                value={formData.delai_appareillage}
                onChange={handleChange}
                className="form-control"
              />
            </div>
          )}
          <br></br>

          <div className="form-row">
            <div className="form-group">
              <label htmlFor="moyen_proximite">Moyens Ã  proximitÃ©</label>
              <input
                type="text"
                id="moyen_proximite"
                name="moyen_proximite"
                value={formData.moyen_proximite}
                onChange={handleChange}
                className="form-control"

              />
            </div>

            <div className="form-group">
              <label htmlFor="moyen_depeche">Moyens dÃ©pÃªchÃ©s sur zone</label>
              <input
                type="text"
                id="moyen_depeche"
                name="moyen_depeche"
                value={formData.moyen_depeche}
                onChange={handleChange}
                className="form-control"

              />
            </div>
          </div>

          <div className="form-group">
            <label htmlFor="moyen_marine_etat">Moyens maritimes ou de lâ€™Ã‰tat</label>
            <input
              type="text"
              id="moyen_marine_etat"
              name="moyen_marine_etat"
              value={formData.moyen_marine_etat}
              onChange={handleChange}
              className="form-control"

            />
          </div>

          <div className="form-row">
            <div className="form-group">
              <label htmlFor="risque_court_terme">Risque prÃ©visible Ã  court terme</label>
              <input
                type="text"
                id="risque_court_terme"
                name="risque_court_terme"
                value={formData.risque_court_terme}
                onChange={handleChange}
                className="form-control"
                rows={3}
              />
            </div>

            <div className="form-group">
              <label htmlFor="risque_moyen_long_terme">
                Risque prÃ©visible Ã  moyen et long terme
              </label>
              <input
                type="text"
                id="risque_moyen_long_terme"
                name="risque_moyen_long_terme"
                value={formData.risque_moyen_long_terme}
                onChange={handleChange}
                className="form-control"
                rows={3}
              />
            </div>
          </div>

        </div>

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {/* SECTION 7 : DESCRIPTION DÃ‰TAILLÃ‰E                                   */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        <div className="form-section">
          <h2>Description DÃ©taillÃ©e</h2>

          <div className="form-group">
            <label htmlFor="description_globale">
              Description globale de l'Ã©vÃ©nement *
              <span className="tooltip-icon" title="DÃ©crivez en dÃ©tail ce qui s'est passÃ©">â„¹ï¸</span>
            </label>
            <textarea
              id="description_globale"
              name="description_globale"
              value={formData.description_globale}
              onChange={handleChange}
              className="form-control"
              placeholder="DÃ©crivez l'Ã©vÃ©nement de maniÃ¨re dÃ©taillÃ©e : que s'est-il passÃ©, oÃ¹, quand, comment..."
              required
              rows="6"
            />
          </div>
        </div>

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {/* BOUTONS D'ACTION                                                     */}
        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        <div className="form-actions">
          <button
            type="submit"
            className={`btn-primary ${isSubmitting ? 'loading' : ''}`}
            disabled={isSubmitting}
          >
            {isSubmitting ? 'Modification ...' : 'Modifier le rapport'}
          </button>
        </div>

        {/* Bouton d'archivage avec confirmation */}
        <div className="form-actions">
          <button
            type="button"
            className="btn-secondary"
            onClick={handleArchiver}
            style={{ backgroundColor: '#a00', color: 'white', padding: '10px 20px', fontSize: '1rem', marginTop: '1rem' }}
          >
            ğŸ—ƒï¸ Archiver ce rapport
          </button>
        </div>
      </form>
      
      <br></br>
      
      {/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {/* AFFICHAGE DES MESSAGES DE STATUT                                       */}
      {/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
      {submitStatus && (
        <div className={`status-message ${submitStatus.type}`}>
          {submitStatus.message}
        </div>
      )}
    </div>
  );

};

export default ModifierRapport;